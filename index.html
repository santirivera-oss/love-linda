<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Un Regalo Especial para Linda ðŸŒ·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --primary-pink: #ff6b81;
            --soft-pink: #ffb6c1;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #ff9a9e;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        /* Capa de Interfaz */
        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* Controles de movimiento */
        #joystick-container {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            pointer-events: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            display: none; /* Se activa al anochecer */
            justify-content: center;
            align-items: center;
        }

        #joystick-knob {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        #action-btn {
            position: absolute;
            bottom: 60px;
            right: 40px;
            width: 80px;
            height: 80px;
            background: var(--primary-pink);
            color: white;
            border: none;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.9rem;
            display: none;
            pointer-events: auto;
            box-shadow: 0 0 20px rgba(255, 107, 129, 0.6);
            cursor: pointer;
            text-transform: uppercase;
        }

        /* Carta */
        .card-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(255, 255, 255, 0.98);
            padding: 30px;
            border-radius: 25px;
            width: 320px;
            max-width: 85%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            opacity: 0;
        }

        .card-content.visible {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        #message {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 20px;
            color: #333;
            font-style: italic;
        }

        .btn-next {
            background: linear-gradient(45deg, var(--primary-pink), #ff9aa2);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 25px;
            width: 100%;
            cursor: pointer;
            font-weight: bold;
        }

        #music-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 50px;
            pointer-events: auto;
            font-size: 0.8rem;
        }

        #hint {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0,0,0,0.4);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            text-align: center;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <button id="music-btn">ðŸŽµ MÃºsica: OFF</button>
        <div id="hint">Observa el atardecer... ðŸŒ…</div>
        
        <div id="joystick-container">
            <div id="joystick-knob"></div>
        </div>

        <button id="action-btn">Tomar</button>

        <div class="card-content" id="card">
            <p id="message"></p>
            <button class="btn-next" id="nextBtn">Siguiente âœ¨</button>
        </div>
    </div>

    <script>
        let scene, camera, renderer, clock = new THREE.Clock();
        let player, specialFlower, envelope, stars, flowers = [];
        let moveDir = { x: 0, z: 0 };
        let sequenceStarted = false, currentMsg = 0;
        let nightStarted = false;
        
        const skyColors = {
            day: new THREE.Color(0xffa07a),
            night: new THREE.Color(0x020111)
        };

        const messages = [
            "Linda, encontraste la flor mÃ¡s linda del campo... ðŸŒ·",
            "Me recuerda a ti, porque brilla con luz propia âœ¨",
            "QuerÃ­a darte este pequeÃ±o detalle para recordarte...",
            "...que eres una persona increÃ­blemente especial ðŸ’•",
            "Te quiero muchÃ­simo, Linda ðŸ’—"
        ];

        window.onload = () => { init(); animate(); };

        function init() {
            scene = new THREE.Scene();
            scene.background = skyColors.day.clone();
            scene.fog = new THREE.FogExp2(0xffa07a, 0.05);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 10);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            // Luces
            const ambient = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambient);
            const sunLight = new THREE.DirectionalLight(0xffd700, 1);
            sunLight.position.set(5, 5, -10);
            scene.add(sunLight);

            // Personaje (invisible hasta que anochece)
            const playerGeo = new THREE.SphereGeometry(0.3, 16, 16);
            const playerMat = new THREE.MeshStandardMaterial({ 
                color: 0xffffff, 
                emissive: 0xffffff, 
                emissiveIntensity: 0 
            });
            player = new THREE.Mesh(playerGeo, playerMat);
            player.position.set(0, 0.3, 5);
            player.visible = false;
            scene.add(player);
            
            const playerLight = new THREE.PointLight(0xffffff, 0, 5);
            player.add(playerLight);

            // Suelo
            const floor = new THREE.Mesh(
                new THREE.PlaneGeometry(100, 100),
                new THREE.MeshPhongMaterial({ color: 0x152215 })
            );
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Crear Flores
            for(let i=0; i<100; i++) {
                const isSpecial = i === 0;
                const flower = createFlower(isSpecial);
                
                let x, z;
                if(isSpecial) {
                    // La flor especial SIEMPRE en el centro accesible
                    x = 0;
                    z = -2;
                } else {
                    x = THREE.MathUtils.randFloatSpread(25);
                    z = THREE.MathUtils.randFloatSpread(25) - 5;
                }
                
                flower.position.set(x, 0, z);
                scene.add(flower);
                flowers.push(flower);
                if(isSpecial) specialFlower = flower;
            }

            // Estrellas
            const starGeo = new THREE.BufferGeometry();
            const starPos = [];
            for(let i=0; i<3000; i++) {
                starPos.push(THREE.MathUtils.randFloatSpread(100), THREE.MathUtils.randFloat(2, 50), THREE.MathUtils.randFloatSpread(100));
            }
            starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
            stars = new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.05, transparent: true, opacity: 0 }));
            scene.add(stars);

            createEnvelope();
            setupControls();
            window.addEventListener('resize', onWindowResize);
        }

        function createFlower(special) {
            const group = new THREE.Group();
            const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.03, 0.03, 1), new THREE.MeshPhongMaterial({ color: 0x1a3311 }));
            stem.position.y = 0.5;
            group.add(stem);

            const petalMat = new THREE.MeshPhongMaterial({ 
                color: special ? 0xff6b81 : 0xffb6c1,
                emissive: special ? 0xff6b81 : 0x000000,
                emissiveIntensity: 0
            });

            for(let i=0; i<5; i++) {
                const p = new THREE.Mesh(new THREE.SphereGeometry(0.2, 8, 8), petalMat);
                p.scale.set(0.5, 1, 0.2);
                p.position.y = 1;
                p.rotation.y = (i * Math.PI * 2) / 5;
                p.translateZ(0.1);
                group.add(p);
            }
            return group;
        }

        function createEnvelope() {
            envelope = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1, 0.05), new THREE.MeshPhongMaterial({ color: 0xffffff }));
            envelope.add(body);
            const flap = new THREE.Mesh(new THREE.ConeGeometry(0.8, 0.6, 4), new THREE.MeshPhongMaterial({ color: 0xf0f0f0 }));
            flap.rotation.set(Math.PI, Math.PI/4, 0);
            flap.position.set(0, 0.25, 0.03);
            flap.name = "flap";
            envelope.add(flap);
            envelope.scale.set(0, 0, 0);
            scene.add(envelope);
        }

        function setupControls() {
            window.addEventListener('keydown', (e) => {
                if(!nightStarted) return;
                if(e.key === 'ArrowUp' || e.key === 'w') moveDir.z = -1;
                if(e.key === 'ArrowDown' || e.key === 's') moveDir.z = 1;
                if(e.key === 'ArrowLeft' || e.key === 'a') moveDir.x = -1;
                if(e.key === 'ArrowRight' || e.key === 'd') moveDir.x = 1;
            });
            window.addEventListener('keyup', (e) => {
                if(['ArrowUp','ArrowDown','w','s'].includes(e.key)) moveDir.z = 0;
                if(['ArrowLeft','ArrowRight','a','d'].includes(e.key)) moveDir.x = 0;
            });

            const joy = document.getElementById('joystick-container');
            const knob = document.getElementById('joystick-knob');
            const handleJoy = (e) => {
                if(!nightStarted) return;
                e.preventDefault();
                const touch = e.touches ? e.touches[0] : e;
                const rect = joy.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const dx = touch.clientX - centerX;
                const dy = touch.clientY - centerY;
                const dist = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
                const angle = Math.atan2(dy, dx);
                knob.style.transform = `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px)`;
                moveDir.x = Math.cos(angle) * (dist / 40);
                moveDir.z = Math.sin(angle) * (dist / 40);
            };
            joy.addEventListener('touchstart', handleJoy);
            joy.addEventListener('touchmove', handleJoy);
            joy.addEventListener('touchend', () => {
                knob.style.transform = `translate(0,0)`;
                moveDir = { x: 0, z: 0 };
            });

            document.getElementById('action-btn').onclick = startSequence;
        }

        function startSequence() {
            sequenceStarted = true;
            document.getElementById('action-btn').style.display = 'none';
            document.getElementById('joystick-container').style.display = 'none';
            document.getElementById('hint').style.display = 'none';
            envelope.position.set(specialFlower.position.x, 1, specialFlower.position.z);
            let step = 0;
            const anim = setInterval(() => {
                step += 0.02;
                camera.position.lerp(player.position.clone().add(new THREE.Vector3(0, 2, 4)), 0.1);
                camera.lookAt(envelope.position);
                if(envelope.scale.x < 1) envelope.scale.addScalar(0.05);
                if(step >= 1.2) {
                    clearInterval(anim);
                    openEnvelope();
                }
            }, 20);
        }

        function openEnvelope() {
            const flap = envelope.getObjectByName('flap');
            let angle = 0;
            const openInt = setInterval(() => {
                angle += 0.1;
                flap.rotation.x = Math.PI - angle;
                if(angle >= Math.PI * 0.8) clearInterval(openInt);
            }, 20);
            setTimeout(() => {
                document.getElementById('card').classList.add('visible');
                document.getElementById('message').textContent = messages[0];
            }, 600);
        }

        document.getElementById('nextBtn').onclick = () => {
            currentMsg++;
            if(currentMsg < messages.length) {
                document.getElementById('message').textContent = messages[currentMsg];
            } else {
                document.getElementById('message').textContent = "Eres mi descubrimiento mÃ¡s bonito. â¤ï¸";
                document.getElementById('nextBtn').style.display = 'none';
            }
        };

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();
            const t = clock.getElapsedTime();

            // LÃ³gica Atardecer -> Noche (Dura 8 segundos)
            const nightFactor = Math.min(t / 8, 1);
            scene.background.lerpColors(skyColors.day, skyColors.night, nightFactor);
            scene.fog.color.lerpColors(skyColors.day, skyColors.night, nightFactor);
            stars.material.opacity = nightFactor;

            if(nightFactor >= 1 && !nightStarted) {
                nightStarted = true;
                player.visible = true;
                player.material.emissiveIntensity = 2;
                player.children[0].intensity = 1;
                document.getElementById('joystick-container').style.display = 'flex';
                document.getElementById('hint').textContent = "Â¡Mira, saliÃ³ una flor brillante! âœ¨";
                setTimeout(() => { if(!sequenceStarted) document.getElementById('hint').textContent = "Ve hacia ella..."; }, 4000);
            }

            if(nightStarted && !sequenceStarted) {
                player.position.x += moveDir.x * 0.1;
                player.position.z += moveDir.z * 0.1;
                player.position.x = Math.max(-12, Math.min(12, player.position.x));
                player.position.z = Math.max(-12, Math.min(12, player.position.z));
                camera.position.x += (player.position.x - camera.position.x) * 0.05;
                camera.position.z += ((player.position.z + 6) - camera.position.z) * 0.05;
                camera.lookAt(player.position.x, 1, player.position.z);
                const dist = player.position.distanceTo(specialFlower.position);
                document.getElementById('action-btn').style.display = (dist < 1.5) ? 'block' : 'none';
            }

            // Brillo especial
            const pulse = (Math.sin(t * 3) + 1) / 2;
            specialFlower.children.forEach(c => {
                if(c.material && c.material.emissiveIntensity !== undefined) {
                    c.material.emissiveIntensity = nightFactor * (0.5 + pulse * 2);
                }
            });

            flowers.forEach((f, i) => {
                f.rotation.z = Math.sin(t * 0.5 + i) * 0.02;
            });

            if(sequenceStarted) {
                envelope.position.y = 1.2 + Math.sin(t * 2) * 0.1;
                envelope.rotation.y += 0.01;
            }

            renderer.render(scene, camera);
        }

        let audioCtx, isPlaying = false;
        document.getElementById('music-btn').onclick = function() {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if(audioCtx.state === 'suspended') audioCtx.resume();
            if(!isPlaying) {
                isPlaying = true;
                this.textContent = "ðŸ”Š MÃºsica: ON";
                playMelody();
            } else {
                isPlaying = false;
                this.textContent = "ðŸŽµ MÃºsica: OFF";
            }
        };

        function playMelody() {
            if(!isPlaying) return;
            const melody = [329.63, 392.00, 440.00, 523.25, 440.00, 392.00];
            let now = audioCtx.currentTime;
            melody.forEach((f, i) => {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.frequency.value = f;
                g.gain.setValueAtTime(0, now + i * 0.8);
                g.gain.linearRampToValueAtTime(0.05, now + i * 0.8 + 0.1);
                g.gain.exponentialRampToValueAtTime(0.001, now + i * 0.8 + 0.7);
                osc.connect(g); g.connect(audioCtx.destination);
                osc.start(now + i * 0.8); osc.stop(now + i * 0.8 + 0.8);
            });
            setTimeout(() => { if(isPlaying) playMelody(); }, melody.length * 800);
        }
    </script>
</body>
</html>